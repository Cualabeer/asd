<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Mechanic Pro Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background: #1e1e2f; color: #eee; font-family: Arial, sans-serif; padding: 20px; }
h1, h2 { color: #fff; }
.card { background: #2b2b3d; margin-bottom: 20px; }
#log-content { height: 300px; overflow-y: scroll; background: #111; padding: 10px; font-family: monospace; color: #0f0; }
#alerts-content { height: 200px; overflow-y: scroll; background: #222; padding: 10px; font-family: monospace; color: #ff0; }
</style>
</head>
<body>

<h1>ðŸš€ Mobile Mechanic Pro Dashboard</h1>

<div class="row">
  <div class="col-md-6">
    <div class="card p-3">
      <h2>Status</h2>
      <p>Backend: <span id="backend-status">Loading...</span></p>
      <p>MongoDB: <span id="mongo-status">Loading...</span></p>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3">
      <h2>Counts</h2>
      <p id="user-count">Users: 0</p>
      <p id="booking-count">Bookings: 0</p>
      <p id="mechanic-count">Mechanics: 0</p>
    </div>
  </div>
</div>

<div class="card p-3">
  <h2>Logs</h2>
  <pre id="log-content">Loading logs...</pre>
</div>

<div class="card p-3">
  <h2>Alerts</h2>
  <pre id="alerts-content">Loading alerts...</pre>
</div>

<div class="card p-3">
  <h2>7-Day Trends</h2>
  <canvas id="trendChart" width="400" height="200"></canvas>
</div>

<script>
const token = new URLSearchParams(window.location.search).get('token');
if (!token) {
  document.body.innerHTML = "<h2 style='color:red'>Unauthorized: REPORT_TOKEN required</h2>";
} else {

  async function fetchStats() {
    try {
      const res = await fetch(`/api/dashboard/status?token=${token}`);
      const data = await res.json();
      document.getElementById('backend-status').textContent = data.backend;
      document.getElementById('mongo-status').textContent = data.mongo;
      document.getElementById('user-count').textContent = 'Users: ' + data.users;
      document.getElementById('booking-count').textContent = 'Bookings: ' + data.bookings;
      document.getElementById('mechanic-count').textContent = 'Mechanics: ' + data.mechanics;
    } catch(err) { console.error(err); }
  }

  async function fetchLogs() {
    try {
      const res = await fetch(`/logs/startup.log`);
      const text = await res.text();
      const logEl = document.getElementById('log-content');
      logEl.textContent = text;
      logEl.scrollTop = logEl.scrollHeight;
    } catch(err) { console.error(err); }
  }

  async function fetchAlerts() {
    try {
      const res = await fetch(`/api/dashboard/alerts?token=${token}`);
      const text = await res.text();
      const alertEl = document.getElementById('alerts-content');
      alertEl.textContent = text;
      alertEl.scrollTop = alertEl.scrollHeight;
    } catch(err) { console.error(err); }
  }

  const ctx = document.getElementById('trendChart').getContext('2d');
  const trendChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Users', data: [], borderColor: 'blue', fill: false },
      { label: 'Bookings', data: [], borderColor: 'green', fill: false },
      { label: 'Mechanics', data: [], borderColor: 'orange', fill: false }
    ]},
    options: { responsive: true, maintainAspectRatio: false }
  });

  async function updateChart() {
    try {
      const res = await fetch(`/api/dashboard/stats-trend?token=${token}`);
      const trendData = await res.json();
      trendChart.data.labels = trendData.labels;
      trendChart.data.datasets[0].data = trendData.users;
      trendChart.data.datasets[1].data = trendData.bookings;
      trendChart.data.datasets[2].data = trendData.mechanics;
      trendChart.update();
    } catch(err) { console.error(err); }
  }

  // Initial load
  fetchStats();
  fetchLogs();
  fetchAlerts();
  updateChart();

  // Refresh intervals
  setInterval(fetchStats, 30000);
  setInterval(fetchLogs, 10000);
  setInterval(fetchAlerts, 15000);
  setInterval(updateChart, 30000);
}
</script>

</body>
</html>